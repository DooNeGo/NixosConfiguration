{ pkgs, pkgs-unstable, config, ... }:
let
  androidComposition = pkgs.androidenv.composeAndroidPackages {
    platformVersions = [ "33" "35" "36" ];
    buildToolsVersions = [ "latest" ];
    systemImageTypes = [ "google_apis" ];
    abiVersions = [ "x86_64" ];
    includeEmulator = "if-supported";
    includeCmake = false;
    includeSources = true;
    includeSystemImages = true;
    extraLicenses = [ "android-sdk-license" ];
  };

  riderFHS = pkgs.buildFHSEnv {
    name = "rider-fhs";
    targetPkgs = pkgs: with pkgs-unstable; [
      jetbrains.rider

      gtk3
      dbus
      libglvnd

     # wayland-protocols
     # mesa
     # libdecor
     # libdrm
     # xdg-desktop-portal

      openssl
    ];
   # profile = ''
   #   export _JAVA_OPTIONS="-Dawt.toolkit.name=WLToolkit -Dij.load.shell.env=true $_JAVA_OPTIONS"
   # '';
    runScript = "rider";
  };
in { 
  home = {
    packages = with pkgs; [
      javaPackages.compiler.temurin-bin.jdk-21
      dotnet-sdk_10
      androidComposition.androidsdk
      riderFHS
    ];

    sessionVariables = {
      JAVA_HOME = "${pkgs.javaPackages.compiler.temurin-bin.jdk-21.home}";
      DOTNET_ROOT = "${pkgs.dotnet-sdk_10}/share/dotnet";
      PATH="${pkgs.dotnet-sdk_10}/bin:$PATH";
      ANDROID_HOME = "${androidComposition.androidsdk}/libexec/android-sdk";
      ANDROID_AVD_HOME = "$HOME/.android/avd";
    };

    file.".android/avd".source = config.lib.file.mkOutOfStoreSymlink "/var/lib/nocow/android-avds";
  };
}
